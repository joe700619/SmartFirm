{% extends 'base.html' %}
{% load static %}

{% block title %}{{ action }} - SmartFirm{% endblock %}

{% block extra_css %}
<style>
    .calculated-field {
        background-color: #f8f9fa;
        cursor: not-allowed;
    }

    .financial-table th {
        background-color: #0d6efd;
        color: white;
        text-align: center;
    }

    .financial-table td {
        vertical-align: middle;
    }

    .account-name {
        font-weight: bold;
        background-color: #e7f1ff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>{{ action }}</h2>
        <a href="{% url 'admin_module:booking_check:list' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> 返回列表
        </a>
    </div>

    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
    {% endif %}

    <form method="post" id="bookkeeping-form">
        {% csrf_token %}

        <!-- 區塊一：基本資訊 -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> 基本資訊</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.sequence_number.label_tag }}
                        {{ form.sequence_number }}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.check_period.label_tag }}
                        {{ form.check_period }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.company_id.label_tag }}
                        {{ form.company_id }}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.company_name.label_tag }}
                        {{ form.company_name }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.bookkeeper.label_tag }}
                        {{ form.bookkeeper }}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.status.label_tag }}
                        {{ form.status }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.industry_code.label_tag }}
                        {{ form.industry_code }}
                    </div>
                    <div class="col-md-6 mb-3">
                        {{ form.industry_name.label_tag }}
                        {{ form.industry_name }}
                    </div>
                </div>
            </div>
        </div>

        <!-- 區塊二：財務報表表格 -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-table"></i> 財務報表</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered financial-table">
                        <thead>
                            <tr>
                                <th width="20%">科目別</th>
                                <th width="26%">帳列數</th>
                                <th width="26%">申報數</th>
                                <th width="26%">剔除數</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 收入 -->
                            <tr>
                                <td class="account-name">收入</td>
                                <td>{{ form.revenue_listed }}</td>
                                <td>{{ form.revenue_reported }}</td>
                                <td><input type="text" class="form-control amount-field calculated-field"
                                        id="revenue_excluded" readonly></td>
                            </tr>
                            <!-- 成本 -->
                            <tr>
                                <td class="account-name">成本</td>
                                <td>{{ form.cost_listed }}</td>
                                <td>{{ form.cost_reported }}</td>
                                <td><input type="text" class="form-control amount-field calculated-field"
                                        id="cost_excluded" readonly></td>
                            </tr>
                            <!-- 毛利（自動計算）-->
                            <tr class="table-warning">
                                <td class="account-name">毛利</td>
                                <td>{{ form.gross_profit_listed }}</td>
                                <td>{{ form.gross_profit_reported }}</td>
                                <td><input type="text" class="form-control amount-field calculated-field"
                                        id="gross_profit_excluded" readonly></td>
                            </tr>
                            <!-- 營業費用 -->
                            <tr>
                                <td class="account-name">營業費用</td>
                                <td>{{ form.operating_expense_listed }}</td>
                                <td>{{ form.operating_expense_reported }}</td>
                                <td><input type="text" class="form-control amount-field calculated-field"
                                        id="operating_expense_excluded" readonly></td>
                            </tr>
                            <!-- 營業利益（自動計算） -->
                            <tr class="table-warning">
                                <td class="account-name">營業利益</td>
                                <td>{{ form.operating_profit_listed }}</td>
                                <td>{{ form.operating_profit_reported }}</td>
                                <td><input type="text" class="form-control amount-field calculated-field"
                                        id="operating_profit_excluded" readonly></td>
                            </tr>
                            <!-- 業外收入 -->
                            <tr>
                                <td class="account-name">業外收入</td>
                                <td>{{ form.non_operating_income_listed }}</td>
                                <td>{{ form.non_operating_income_reported }}</td>
                                <td><input type="text" class="form-control amount-field calculated-field"
                                        id="non_operating_income_excluded" readonly></td>
                            </tr>
                            <!-- 業外支出 -->
                            <tr>
                                <td class="account-name">業外支出</td>
                                <td>{{ form.non_operating_expense_listed }}</td>
                                <td>{{ form.non_operating_expense_reported }}</td>
                                <td><input type="text" class="form-control amount-field calculated-field"
                                        id="non_operating_expense_excluded" readonly></td>
                            </tr>
                            <!-- 淨利（自動計算） -->
                            <tr class="table-info">
                                <td class="account-name">淨利</td>
                                <td>{{ form.net_profit_listed }}</td>
                                <td>{{ form.net_profit_reported }}</td>
                                <td><input type="text" class="form-control amount-field calculated-field"
                                        id="net_profit_excluded" readonly></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 區塊三：結論 -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-journal-text"></i> 結論</h5>
            </div>
            <div class="card-body">
                {{ form.conclusion.label_tag }}
                {{ form.conclusion }}
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mb-4">
            <a href="{% url 'admin_module:booking_check:list' %}" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> 取消
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-circle"></i> 儲存
            </button>
        </div>
    </form>
</div>

<!-- 引入可重用的 JavaScript 模組 -->
<script src="{% static 'js/thousand-separator.js' %}"></script>
<script src="{% static 'js/enter-key-navigation.js' %}"></script>

<script>
    // 初始化函數 - 確保可以在文檔載入完成時或之後執行
    function initBookkeepingChecklist() {
        console.log('Initializing bookkeeping checklist...');

        // ⚠️ 不要調用 ThousandSeparator.init() - 它會添加自己的事件監聽器造成衝突
        // ThousandSeparator.init('.amount-field', { maxDecimals: 2 });

        // 初始化 Enter 鍵導航
        EnterKeyNavigation.init('#bookkeeping-form', {
            excludeTextareas: true,
            submitOnLast: false
        });

        // 獲取所有輸入欄位
        const fields = {
            revenue_listed: document.getElementById('id_revenue_listed'),
            revenue_reported: document.getElementById('id_revenue_reported'),
            cost_listed: document.getElementById('id_cost_listed'),
            cost_reported: document.getElementById('id_cost_reported'),
            gross_profit_listed: document.getElementById('id_gross_profit_listed'),
            gross_profit_reported: document.getElementById('id_gross_profit_reported'),
            operating_expense_listed: document.getElementById('id_operating_expense_listed'),
            operating_expense_reported: document.getElementById('id_operating_expense_reported'),
            operating_profit_listed: document.getElementById('id_operating_profit_listed'),
            operating_profit_reported: document.getElementById('id_operating_profit_reported'),
            non_operating_income_listed: document.getElementById('id_non_operating_income_listed'),
            non_operating_income_reported: document.getElementById('id_non_operating_income_reported'),
            non_operating_expense_listed: document.getElementById('id_non_operating_expense_listed'),
            non_operating_expense_reported: document.getElementById('id_non_operating_expense_reported'),
            net_profit_listed: document.getElementById('id_net_profit_listed'),
            net_profit_reported: document.getElementById('id_net_profit_reported'),
        };

        // 獲取剔除數欄位
        const excludedFields = {
            revenue: document.getElementById('revenue_excluded'),
            cost: document.getElementById('cost_excluded'),
            gross_profit: document.getElementById('gross_profit_excluded'),
            operating_expense: document.getElementById('operating_expense_excluded'),
            operating_profit: document.getElementById('operating_profit_excluded'),
            non_operating_income: document.getElementById('non_operating_income_excluded'),
            non_operating_expense: document.getElementById('non_operating_expense_excluded'),
            net_profit: document.getElementById('net_profit_excluded'),
        };

        // 計算函數
        function calculateAll() {
            console.log('calculateAll triggered');

            // 取得數值（移除千分位）
            const revenueL = parseFloat(ThousandSeparator.parseNumber(fields.revenue_listed.value)) || 0;
            const revenueR = parseFloat(ThousandSeparator.parseNumber(fields.revenue_reported.value)) || 0;
            const costL = parseFloat(ThousandSeparator.parseNumber(fields.cost_listed.value)) || 0;
            const costR = parseFloat(ThousandSeparator.parseNumber(fields.cost_reported.value)) || 0;
            const opExpL = parseFloat(ThousandSeparator.parseNumber(fields.operating_expense_listed.value)) || 0;
            const opExpR = parseFloat(ThousandSeparator.parseNumber(fields.operating_expense_reported.value)) || 0;
            const nonOpIncL = parseFloat(ThousandSeparator.parseNumber(fields.non_operating_income_listed.value)) || 0;
            const nonOpIncR = parseFloat(ThousandSeparator.parseNumber(fields.non_operating_income_reported.value)) || 0;
            const nonOpExpL = parseFloat(ThousandSeparator.parseNumber(fields.non_operating_expense_listed.value)) || 0;
            const nonOpExpR = parseFloat(ThousandSeparator.parseNumber(fields.non_operating_expense_reported.value)) || 0;

            // 計算毛利 = 收入 - 成本
            const grossProfitL = revenueL - costL;
            const grossProfitR = revenueR - costR;

            // 計算營業利益 = 毛利 - 營業費用
            const opProfitL = grossProfitL - opExpL;
            const opProfitR = grossProfitR - opExpR;

            // 計算淨利 = 營業利益 + 業外收入 - 業外支出
            const netProfitL = opProfitL + nonOpIncL - nonOpExpL;
            const netProfitR = opProfitR + nonOpIncR - nonOpExpR;

            // 更新計算欄位（直接使用formatNumber手動格式化，避免initElement添加事件監聽器）
            fields.gross_profit_listed.value = ThousandSeparator.formatNumber(grossProfitL.toFixed(2));
            fields.operating_profit_listed.value = ThousandSeparator.formatNumber(opProfitL.toFixed(2));
            fields.net_profit_listed.value = ThousandSeparator.formatNumber(netProfitL.toFixed(2));

            fields.gross_profit_reported.value = ThousandSeparator.formatNumber(grossProfitR.toFixed(2));
            fields.operating_profit_reported.value = ThousandSeparator.formatNumber(opProfitR.toFixed(2));
            fields.net_profit_reported.value = ThousandSeparator.formatNumber(netProfitR.toFixed(2));

            // 計算並填入剔除數（帳列數 - 申報數，手動格式化）
            excludedFields.revenue.value = ThousandSeparator.formatNumber((revenueL - revenueR).toFixed(2));
            excludedFields.cost.value = ThousandSeparator.formatNumber((costL - costR).toFixed(2));
            excludedFields.gross_profit.value = ThousandSeparator.formatNumber((grossProfitL - grossProfitR).toFixed(2));
            excludedFields.operating_expense.value = ThousandSeparator.formatNumber((opExpL - opExpR).toFixed(2));
            excludedFields.operating_profit.value = ThousandSeparator.formatNumber((opProfitL - opProfitR).toFixed(2));
            excludedFields.non_operating_income.value = ThousandSeparator.formatNumber((nonOpIncL - nonOpIncR).toFixed(2));
            excludedFields.non_operating_expense.value = ThousandSeparator.formatNumber((nonOpExpL - nonOpExpR).toFixed(2));
            excludedFields.net_profit.value = ThousandSeparator.formatNumber((netProfitL - netProfitR).toFixed(2));

            console.log('Calculation complete - all fields updated with formatted values');
        }

        // 為可編輯欄位添加千分位格式化（blur時手動格式化）
        Object.values(fields).forEach(field => {
            if (field && !field.readOnly) {
                field.addEventListener('blur', function () {
                    if (this.value) {
                        const raw = ThousandSeparator.parseNumber(this.value);
                        this.value = ThousandSeparator.formatNumber(raw);
                    }
                });
            }
        });

        // 監聽所有輸入欄位變化觸發計算
        Object.entries(fields).forEach(([key, field]) => {
            if (field && !field.readOnly) {
                field.addEventListener('input', function () {
                    console.log('Input event on:', key);
                    calculateAll();
                });
            }
        });

        // 初始計算
        setTimeout(() => {
            calculateAll();
        }, 100);

        console.log('Bookkeeping checklist form initialized successfully');
    }

    // 檢查文檔載入狀態並執行初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initBookkeepingChecklist);
    } else {
        // DOM 已經載入完成，直接執行初始化
        initBookkeepingChecklist();
    }
</script>
{% endblock %}