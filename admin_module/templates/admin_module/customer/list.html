{% extends 'base.html' %}

{% block title %}客戶資料列表 - SmartFirm{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<style>
    table.dataTable.hover tbody tr:hover,
    table.dataTable.display tbody tr:hover {
        background-color: #f6f6f6;
    }
</style>
{% endblock %}

{% block page_header %}客戶資料{% endblock %}
{% block breadcrumb %}客戶列表{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">

        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
        {% endif %}

        <!-- 客戶列表 Card -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">客戶列表</h3>
                <div class="card-tools">
                    <a href="{% url 'admin_module:customer:create' %}" class="btn btn-primary btn-sm">
                        <i class="bi bi-plus-circle"></i> 新增客戶
                    </a>
                </div>
            </div>
            <!-- /.card-header -->
            <div class="card-body">
                <div class="table-responsive">
                    <table id="customerTable" class="table table-hover align-middle">
                        <thead class="table-light border-bottom border-2 fw-bold">
                            <tr>
                                <th width="40" class="text-center">
                                    <input type="checkbox" id="selectAll" class="form-check-input">
                                </th>
                                <th>公司統編</th>
                                <th>公司名稱</th>
                                <th>聯絡人</th>
                                <th>電子郵件</th>
                                <th>聯絡電話</th>
                                <th>Line ID</th>
                                <th>登記地址</th>
                                <th style="width: 150px">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for customer in customers %}
                            <tr>
                                <td class="text-center">
                                    <input type="checkbox" name="customer_ids" value="{{ customer.pk }}"
                                        class="form-check-input customer-checkbox">
                                </td>
                                <td>{{ customer.companyId }}</td>
                                <td>{{ customer.companyName }}</td>
                                <td>{{ customer.contact }}</td>
                                <td>{{ customer.email|default:"—" }}</td>
                                <td>
                                    {% if customer.phoneNumber %}
                                    <small>公司：{{ customer.phoneNumber }}</small><br>
                                    {% endif %}
                                    {% if customer.phone %}
                                    <small>手機：{{ customer.phone }}</small>
                                    {% endif %}
                                    {% if not customer.phoneNumber and not customer.phone %}
                                    —
                                    {% endif %}
                                </td>
                                <td>{{ customer.LineId|default:"—" }}</td>
                                <td>{{ customer.registration_address|truncatewords:10 }}</td>
                                <td>
                                    <a href="{% url 'admin_module:customer:update' customer.pk %}"
                                        class="btn btn-sm border-0 text-primary" title="編輯">
                                        <i class="bi bi-pencil-fill"></i>
                                    </a>
                                    <a href="{% url 'admin_module:customer:delete' customer.pk %}"
                                        class="btn btn-sm border-0 text-danger" title="刪除">
                                        <i class="bi bi-trash-fill"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- /.card-body -->
        </div>
        <!-- /.card -->

    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

<script>
    $(document).ready(function () {
        var table = $('#customerTable').DataTable({
            "language": {
                "processing": "處理中...",
                "loadingRecords": "載入中...",
                "lengthMenu": "顯示 _MENU_ 項結果",
                "zeroRecords": "沒有符合的結果",
                "info": "顯示第 _START_ 至 _END_ 項結果，共 _TOTAL_ 項",
                "infoEmpty": "顯示第 0 至 0 項結果，共 0 項",
                "infoFiltered": "(從 _MAX_ 項結果中過濾)",
                "infoPostFix": "",
                "search": "搜尋:",
                "paginate": {
                    "first": "第一頁",
                    "previous": "上一頁",
                    "next": "下一頁",
                    "last": "最後一頁"
                },
                "aria": {
                    "sortAscending": ": 升冪排列",
                    "sortDescending": ": 降冪排列"
                }
            },
            "order": [[1, "asc"]], // Default sort by Company ID
            "columnDefs": [
                { "orderable": false, "targets": [0, 8] } // Disable sorting for checkbox and actions
            ],
            "pageLength": 25,
            "dom": '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                '<"row"<"col-sm-12"tr>>' +
                '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
        });

        $('#selectAll').on('click', function (e) {
            var rows = table.rows({ 'search': 'applied' }).nodes();
            $('input[type="checkbox"]', rows).prop('checked', this.checked);
        });

        $('#customerTable tbody').on('change', 'input[type="checkbox"]', function () {
            if (!this.checked) {
                var el = $('#selectAll').get(0);
                if (el && el.checked && ('indeterminate' in el)) {
                    el.indeterminate = true;
                }
            }
        });
    });
</script>
{% endblock %}